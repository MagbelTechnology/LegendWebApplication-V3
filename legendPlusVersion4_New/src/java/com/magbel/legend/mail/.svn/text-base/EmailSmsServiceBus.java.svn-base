/**
 * <p>Title: EmailSmsServiceBus.java</p>
 *
 * <p>Description:Manages Sending of Email and SMS when Confirmation is approved. </p>
 *
 * <p>Copyright: Copyright (c) 2008</p>
 *
 * <p>Company: MagBel Technology LTD.</p>
 *
 * @author Kalu Nsi Idika
 * @version 1.0
 */

package com.magbel.legend.mail;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLEncoder;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.Date;
import java.util.Properties;

import java.security.Security;
import com.sun.mail.smtp.SMTPTransport;
import com.sun.net.ssl.internal.ssl.Provider;
import java.net.Socket;
import javax.mail.internet.*;
import javax.mail.*;

import javax.mail.Address;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.SendFailedException;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;
import com.magbel.legend.bus.ApprovalRecords;


import java.text.*;


public class EmailSmsServiceBus  {
	NumberFormat format = new DecimalFormat("0.00");
	ApprovalRecords app = new ApprovalRecords();
	//MailClient send = new MailClient();
	public EmailSmsServiceBus()
		{
		
		}
	
		public void sendMail(String email, String subject,String msgText1)
		{
			System.out.println("Just called the sendApprovalEmail API");
			try
			{
				Properties prop = new Properties();
				File file = new File("C:\\Property\\FixedAsset.properties");
				System.out.print("Absolute Path:>>> "+file.getAbsolutePath());
				System.out.print("Able to load file ");
				FileInputStream in = new FileInputStream(file);
				prop.load(in);
				System.out.print("Able to load properties into prop");
				String host = prop.getProperty("mail.smtp.host");
				String from = prop.getProperty("mail-user");
				Session session = Session.getDefaultInstance(prop,null);
				
				boolean sessionDebug = true;
				Properties props = System.getProperties();
				props.put("mail.host",host);
				props.put("mail.transport.protocols","smtp");
				System.out.println("setting auth");
				session = Session.getDefaultInstance(props,null);
				session.setDebug(sessionDebug);

				System.out.println("From = "+from);
				System.out.println("point 1");
				
				Message msg = new MimeMessage(session);
				System.out.println("point 2");
				msg.setFrom(new InternetAddress(from));
				System.out.println("point 3");
				String recepient[]=email.split(",");
				String to = recepient[0];
				InternetAddress[] address = { new InternetAddress(to) };
				System.out.println("point 4");
				msg.setRecipients(Message.RecipientType.TO,address);
         
				 msg.setSubject(subject);

				System.out.println("point 6");
				msg.setSentDate(new Date());
				System.out.println("point 7");

				String msgBody = msgText1;
			    System.out.print("The mail body: "+msgBody);
			    msg.setText(msgBody);
			    msg.saveChanges();
				
				System.out.println("point 8");
				
			   
			    		
				System.out.println("point 9");
				//String cc[]={recepient[1],recepient[2],recepient[3]};
				for(int i=0;i<recepient.length;i++)
				{
				InternetAddress addressCopy = new InternetAddress(recepient[i]);	
				msg.setRecipient(Message.RecipientType.CC, addressCopy);
				}	
				System.out.println("point 10");
			  	 
	    Transport tr = session.getTransport("smtp");
	    System.out.println("point 11");
		tr.connect();
		System.out.println("point 12");
	//	Security.getProviders("smtp");
		
		System.out.println("point test");
		//tr.sendMessage(msg, msg.getAllRecipients());
		tr.send(msg);
		System.out.println("point 13");
		tr.close(); 
		
       
		System.out.println("point 14");
			} 
			catch (Exception ex) 
			{
				System.out.println("point 15");
				ex.printStackTrace();
			}

		}		
		
		public void sendMailSupervisor(String id, String subject,String msgText1)
		{
			System.out.println("Just called the sendApprovalEmail API");
			try
			{
				Properties prop = new Properties();
				File file = new File("C:\\Property\\FixedAsset.properties");
				System.out.print("Absolute Path:>>> "+file.getAbsolutePath());
				System.out.print("Able to load file ");
				FileInputStream in = new FileInputStream(file);
				prop.load(in);
				System.out.print("Able to load properties into prop");
				String host = prop.getProperty("mail.smtp.host");
				String from = prop.getProperty("mail-user");
				Session session = Session.getDefaultInstance(prop,null);
				
				boolean sessionDebug = true;
				Properties props = System.getProperties();
				props.put("mail.host",host);
				props.put("mail.transport.protocols","smtp");
				System.out.println("setting auth");
				session = Session.getDefaultInstance(props,null);
				session.setDebug(sessionDebug);

				System.out.println("From = "+from);
				System.out.println("point 1");
				
				Message msg = new MimeMessage(session);
				System.out.println("point 2");
				msg.setFrom(new InternetAddress(from));
				System.out.println("point 3");
				String to = app.userEmail(id);
				InternetAddress[] address = { new InternetAddress(to) };
				System.out.println("point 4");
				msg.setRecipients(Message.RecipientType.TO,address);
         
				 msg.setSubject(subject);

				System.out.println("point 6");
				msg.setSentDate(new Date());
				System.out.println("point 7");

				String msgBody = msgText1;
			    System.out.print("The mail body: "+msgBody);
			    msg.setText(msgBody);
			    msg.saveChanges();
				
				System.out.println("point 8");
				
			   
			    		
				System.out.println("point 9");
				
				System.out.println("point 10");
			  	 
	    Transport tr = session.getTransport("smtp");
	    System.out.println("point 11");
		tr.connect();
		System.out.println("point 12");
	//	Security.getProviders("smtp");
		
		System.out.println("point test");
		//tr.sendMessage(msg, msg.getAllRecipients());
		tr.send(msg);
		System.out.println("point 13");
		tr.close(); 
		
       
		System.out.println("point 14");
			} 
			catch (Exception ex) 
			{
				System.out.println("point 15");
				ex.printStackTrace();
			}

		}	
		
		
		public void sendMailUser(String Asset_id, String subject,String msgText1)
		{
			System.out.println("Just called the sendApprovalEmail API");
			try
			{
				Properties prop = new Properties();
				File file = new File("C:\\Property\\FixedAsset.properties");
				System.out.print("Absolute Path:>>> "+file.getAbsolutePath());
				System.out.print("Able to load file ");
				FileInputStream in = new FileInputStream(file);
				prop.load(in);
				System.out.print("Able to load properties into prop");
				String host = prop.getProperty("mail.smtp.host");
				String from = prop.getProperty("mail-user");
				Session session = Session.getDefaultInstance(prop,null);
				
				boolean sessionDebug = true;
				Properties props = System.getProperties();
				props.put("mail.host",host);
				props.put("mail.transport.protocols","smtp");
				System.out.println("setting auth");
				session = Session.getDefaultInstance(props,null);
				session.setDebug(sessionDebug);

				System.out.println("From = "+from);
				System.out.println("point 1");
				
				Message msg = new MimeMessage(session);
				System.out.println("point 2");
				msg.setFrom(new InternetAddress(from));
				System.out.println("point 3");
				String to = app.userEmail(app.userToEmail(Asset_id));
				InternetAddress[] address = { new InternetAddress(to) };
				System.out.println("point 4");
				msg.setRecipients(Message.RecipientType.TO,address);
         
				 msg.setSubject(subject);

				System.out.println("point 6");
				msg.setSentDate(new Date());
				System.out.println("point 7");

				String msgBody = msgText1;
			    System.out.print("The mail body: "+msgBody);
			    msg.setText(msgBody);
			    msg.saveChanges();
				
				System.out.println("point 8");
				
			   
			    		
				System.out.println("point 9");
				
				System.out.println("point 10");
			  	 
	    Transport tr = session.getTransport("smtp");
	    System.out.println("point 11");
		tr.connect();
		System.out.println("point 12");
	//	Security.getProviders("smtp");
		
		System.out.println("point test");
		//tr.sendMessage(msg, msg.getAllRecipients());
		tr.send(msg);
		System.out.println("point 13");
		tr.close(); 
		
       
		System.out.println("point 14");
			} 
			catch (Exception ex) 
			{
				System.out.println("point 15");
				ex.printStackTrace();
			}

		}	
	public void sendMail(String email, String accountName)
	{
		System.out.println("Just called the sendApprovalEmail API");
		try
		{
			Properties prop = new Properties();
			File file = new File("C:\\Property\\FixedAsset.properties");
			System.out.print("Absolute Path:>>> "+file.getAbsolutePath());
			System.out.print("Able to load file ");
			FileInputStream in = new FileInputStream(file);
			prop.load(in);
			System.out.print("Able to load properties into prop");
			String host = prop.getProperty("mail.smtp.host");
			String from = prop.getProperty("mail-user");
			Session session = Session.getDefaultInstance(prop,null);
			
			boolean sessionDebug = true;
			Properties props = System.getProperties();
			props.put("mail.host",host);
			props.put("mail.transport.protocols","smtp");
			props.put("mail.smtp.auth","enable-authentication");
			System.out.println("setting auth");
			session = Session.getDefaultInstance(props,null);
			session.setDebug(sessionDebug);

			System.out.println("From = "+from);
			System.out.println("point 1");
			
			Message msg = new MimeMessage(session);
			System.out.println("point 2");
			msg.setFrom(new InternetAddress(from));
			System.out.println("point 3");
			InternetAddress[] address = { new InternetAddress(email) };
			System.out.println("point 4");
			msg.setRecipients(Message.RecipientType.TO,address);
     
			 msg.setSubject("Stop Cheque Success Notification");

			System.out.println("point 6");
			msg.setSentDate(new Date());
			System.out.println("point 7");

			String msgBody = "Dear Customer, \n";
		    msgBody += "Notification of successful\n";
		    msgBody += "Cheque Stopped by user "+accountName+".\n";
		    System.out.print("The mail body: "+msgBody);
		    msg.setText(msgBody);
		    msg.saveChanges();
			
			System.out.println("point 8");
			
		   
		    		
			InternetAddress addressCopy = new InternetAddress("oreolanrewaju@yahoo.com");	
			System.out.println("point 9");
			msg.setRecipient(Message.RecipientType.CC, addressCopy);
		    	
			System.out.println("point 10");
		  	 
    Transport tr = session.getTransport("smtp");
    System.out.println("point 11");
	tr.connect();
	System.out.println("point 12");
//	Security.getProviders("smtp");
	
	System.out.println("point test");
	tr.send(msg);
	//tr.sendMessage(msg, msg.getAllRecipients());
	System.out.println("point 13");
	tr.close(); 
	
   
	System.out.println("point 14");
		} 
		catch (Exception ex) 
		{
			System.out.println("point 15");
			ex.printStackTrace();
		}

	}	
		
public void sendEmail(String email, String accountName)
		{
			
			System.out.println("Just called the sendApprovalEmail API");
			//ControlParameter ctrlParam = new ControlParameter();
			//ctrlParam = findCtrlParamValueByCode("PROPERTY_FILE_LOC");
			try
			{
				//File file = new File(ctrlParam.getParameterValue()+"\\CheckPoint.properties");
				Properties prop = new Properties();
				//System.out.print("D:\\Property\\CheckPoint.properties");
				File file = new File("C:\\Property\\FixedAsset.properties");
				System.out.print("Absolute Path:>>> "+file.getAbsolutePath());
				//if(file.exists())
				//{
				System.out.print("Able to load file ");
		
				FileInputStream in = new FileInputStream(file);
				
				//InputStream in = this.getClass().getResourceAsStream("CheckPoint.properties"); //(InputStream)(new FileInputStream(file));
				prop.load(in);
				System.out.print("Able to load properties into prop");
				String host = prop.getProperty("mail.smtp.host");
				String from = prop.getProperty("mail-user");
				String password = prop.getProperty("mail-password");
				String port = prop.getProperty("mail.smtp.port");
				String starttls = prop.getProperty("mail.smtp.starttls.enable");
				
				String auth = prop.getProperty("enable-authentication");
				String strDebug = prop.getProperty("mail.smtp.debug");
				boolean debug = new Boolean(strDebug.trim());
				
				
				//String copyAddress = prop.getProperty("mail.copy.address");
				//String blindCopyAddress = prop.getProperty("mail.blind.copy.address");
			
				System.out.println("From = "+from);
			
				// create some properties and get the default Session
				Properties props = new Properties();
				props.put("mail.smtp.host", host);
				if(!"false".equals(starttls))
				{
			        props.put("mail.smtp.starttls.enable",starttls);
			        props.put("mail.smtp.auth", auth);
				}   
				if(debug){
			        props.put("mail.smtp.debug", "true");
				}else{
			        props.put("mail.smtp.debug", "false");
				}
				if(!"".equals(port))
		        props.put("mail.smtp.socketFactory.port", port);
		
				
				
				Session session = Session.getInstance(props, null);
				session.setDebug(debug);
			
			    // create a message
				System.out.println("About the send the mail>>>>>inside sendApprovalEmail API");
			    Message msg = new MimeMessage(session);
			    msg.setFrom(new InternetAddress(from));
			    InternetAddress address = new InternetAddress(email);
			    //InternetAddress addressBlindCopy = new InternetAddress(blindCopyAddress);
			    msg.setRecipient(Message.RecipientType.TO, address);
			  
				    	InternetAddress addressCopy = new InternetAddress(email);
				    	msg.setRecipient(Message.RecipientType.CC, addressCopy);
			    
			    //msg.setRecipient(Message.RecipientType.BCC, addressBlindCopy);
			    msg.setSubject("Check Confirmation Notification");
			    msg.setSentDate(new Date());
			    		    
			    String msgBody = "Dear  \n";
			    msgBody += "The confirmation of your cheque has been recieved.\n";
			    msgBody += "Below are the details of the confirmed cheque:\n";
			  
			    msgBody += "From:\n UBA Cheque Confirmation Manager";
			    System.out.print("The mail body: "+msgBody);
			    msg.setText(msgBody);
			    msg.saveChanges();
				Transport transport = session.getTransport("smtp");
				transport.connect();
				//transport.connect(host, from, password);
				transport.sendMessage(msg, msg.getAllRecipients());
				transport.close();
				 System.out.print("After sending the mail successfully inside sendApprovalEmail : ");
			//}
			   
			} catch (MessagingException mex) {
			    System.out.println("\n--Exception handling in msgsendsample.java");

			    mex.printStackTrace();
			    System.out.println();
			    Exception ex = mex;
			    do {
				if (ex instanceof SendFailedException) {
				    SendFailedException sfex = (SendFailedException)ex;
				    Address[] invalid = sfex.getInvalidAddresses();
				    if (invalid != null) {
					System.out.println("    ** Invalid Addresses");
					if (invalid != null) {
					    for (int i = 0; i < invalid.length; i++) 
						System.out.println("         " + invalid[i]);
					}
				    }
				    Address[] validUnsent = sfex.getValidUnsentAddresses();
				    if (validUnsent != null) {
					System.out.println("    ** ValidUnsent Addresses");
					if (validUnsent != null) {
					    for (int i = 0; i < validUnsent.length; i++) 
						System.out.println("         "+validUnsent[i]);
					}
				    }
				    Address[] validSent = sfex.getValidSentAddresses();
				    if (validSent != null) {
					System.out.println("    ** ValidSent Addresses");
					if (validSent != null) {
					    for (int i = 0; i < validSent.length; i++) 
						System.out.println("         "+validSent[i]);
					}
				    }
				}
				System.out.println();
				if (ex instanceof MessagingException)
				    ex = ((MessagingException)ex).getNextException();
				else
				    ex = null;
			    } while (ex != null);
			}catch(IOException ioe)
			{
				ioe.printStackTrace();
			}
		}
}
