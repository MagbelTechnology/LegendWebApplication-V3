

package com.magbel.legend.servlet;

import java.io.*;
import java.sql.*;
import java.util.*;
import javax.servlet.*;
import javax.servlet.http.*;
import javax.naming.*;
import javax.sql.DataSource;

import oracle.jdbc.OracleResultSet;
import oracle.sql.BLOB;

import com.magbel.dao.PersistenceServiceDAO;
import com.magbel.util.DataConnect;

import java.sql.Connection;
import java.io.*;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Statement;
import com.magbel.legend.bus.ApprovalRecords;

public class AssetPictureServlet extends HttpServlet {
private ApprovalRecords serviceBus;
PersistenceServiceDAO dao;
private byte[] image;
ServletOutputStream stream = null;
    public void init(ServletConfig config) throws ServletException {
        super.init(config);
        dao = new PersistenceServiceDAO();
    }

    /** Destroys the servlet.
     */
    public void destroy() {

    }

    /** Processes requests for both HTTP <code>GET</code> and <code>POST</code> methods.
     * @param request servlet request
     * @param response servlet response
     */
    public void service(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException {
    	serviceBus = new ApprovalRecords();
        response.setHeader("Pragma", "no-cache");
        response.setHeader("Cache-Control", "no-cache");
        response.setDateHeader("Expires", -1);

        System.out.println("INFO::Entered ImageRendereDBServlet");
        String assetId = request.getParameter("assetId");
        String pageName = request.getParameter("pageName");

        this.image = getImageData(assetId,pageName);
        response.setContentType("image/jpeg");

        if(this.image != null){

            stream = response.getOutputStream();
            stream.write(image);
        }else{

  
        }
    }
/*
    public byte[] loadImage(String chequeNo,String accountNo){

        System.out.println("INFO::Loading Customer image -->");
        byte[] byteArray = null;
        Connection con = null;
        ResultSet rs = null;
        PreparedStatement ps = null;
        try{

            con =  dao.getConnection();
            String query = "SELECT  IMAGE FROM CP_CONFIRMATION_IMAGE "+
            				"WHERE CHEQUE_NO='"+chequeNo+"' AND ACCOUNT_NO='"+accountNo+"'";
            ps = con.prepareStatement(query);
            rs = ps.executeQuery();
            while(rs.next()){
                byteArray = rs.getBytes(1);
            }
        }catch(Exception ex){
            System.out.println("WARNING::Error retriving image -->"+ex);
        }finally{
            dao.closeConnection(con,ps,rs);
        }
        return byteArray;
    }
*/
    //oracle image retrieve
    public byte[] loadImage(final String assetId, final String pageName) {
	
		System.out.println("INFO::Loading Customer image -->");
        byte[] byteArray = null;
		int returnValue = 0;
		Connection conn = null;
		Statement stmt = null;
		ResultSet rs = null;
		InputStream is = null;
		OutputStream os = null;
		BLOB blob = null;
		try {

			conn = dao.getConnection(); 
			
			conn.setAutoCommit(false);
			stmt = conn.createStatement();
		
			String query =  "select image from am_ad_image where assetId='"+assetId+"' and pageName='"+pageName+"'";
			rs = stmt.executeQuery(query);
			if(rs.next()) {
				
				blob = ((OracleResultSet)rs).getBLOB("image");
				is = blob.getBinaryStream();

				final int bufferSize = blob.getBufferSize();
				final byte[] buffer = new byte[bufferSize];
				int bytesRead = 0;
				while ((bytesRead = is.read(buffer)) != -1) {

					byteArray = buffer;
				}
			}
			else {
				returnValue = 1;
			}
		}

		catch(FileNotFoundException e) {
			returnValue = 3;
			e.printStackTrace();
		}
		catch(Exception e) {
			returnValue = 4;
			e.printStackTrace();
		}
		finally {
			
			try {
				if(is != null) {
					is.close();
				}
				if(os != null) {
					os.flush();
					os.close();
				}
				if(stmt != null) {
					stmt.close();
				}
				if(rs != null) {
					rs.close();
				}
				if(conn != null) {
					conn.commit();
					conn.close();
				}
				is = null;
				os = null;
				stmt = null;
				rs = null;
				conn = null;
				blob = null;
			}
			catch(Exception e) {
				returnValue = 5;
				e.printStackTrace();
			}
		}
		return byteArray;
	}
//sql server image retrieve
    public byte[] getImageData(String assetId,String pageName)
    {
            
             byte[] fileBytes=null;
            // File file;
            // file = new File(pathname);
             Connection conn = null;  
             conn = dao.getConnection(); 
             String query;
             try
             {
                     query = "select image from am_ad_image where assetId='"+assetId+"' and pageName='"+pageName+"'";
                     Statement state = conn.createStatement();
                     ResultSet rs = state.executeQuery(query);
                     if (rs.next())
                    {
                              fileBytes = rs.getBytes(1);
                              //OutputStream targetFile = new FileOutputStream("d://filepath//new.JPG");
                              OutputStream targetFile = new FileOutputStream("");
//                              OutputStream targetFile = new FileOutputStream(file);
                              
                              targetFile.write(fileBytes);
                              targetFile.close();
                    }        
                    
             }
             catch (Exception e)
             {
                     e.printStackTrace();
             }
             return fileBytes;
    }
    /** Returns a short description of the servlet.
     */
    public String getServletInfo() {
        return "Binnary Image Display Servlet";
    }

}
