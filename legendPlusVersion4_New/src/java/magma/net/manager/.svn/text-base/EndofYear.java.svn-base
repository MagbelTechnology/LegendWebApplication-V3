package magma.net.manager;

//import magma.net.dao.MagmaDBConnection;
import java.sql.*;
import java.util.StringTokenizer;

import com.magbel.util.DatetimeFormat;
import java.text.SimpleDateFormat;

public class EndofYear extends legend.ConnectionClass {
    private DatetimeFormat dateFormat;
    java.text.SimpleDateFormat sdf;
    public EndofYear() throws Exception {
        System.out.println("INFO-- Performing End of Year Initialization");
        sdf = new java.text.SimpleDateFormat("dd-MM-yyyy");
        dateFormat = new DatetimeFormat();
        //dbConnect = new MagmaDBConnection();

    }


    public boolean resetAssetDepytd() {
        System.out.println("INFO-- Resetting DepYTD");
        String updatesql = "UPDATE AM_ASSET SET DEP_YTD = 0";
        boolean done = false;
        try {
            //Connection con = getConnection("fixedasset");
            Statement stmt = getStatement();
            done = (stmt.executeUpdate(updatesql) != -1);

        } catch (Exception ex) {
            ex.printStackTrace();
        }
        finally{
             freeResource();
        }
        return done;
    }

    public boolean resetFleetMasterValues() {
        System.out.println("INFO-- Resetting otherYTD");
        String updatesql = "UPDATE FT_FLEET_MASTER SET DEP_YTD = 0," +
                           " PREMIUM_PTD = 0, MAINT_PTD = 0, FUEL_PTD = 0," +
                           " ACCIDENT_COST_PTD = 0, LICENCE_PERMIT_PTD = 0," +
                           "MAINT_Q1 = 0, MAINT_Q2 =0, MAINT_Q3 = 0, MAINT_Q4=0";
        boolean done = false;
        try {
            //Connection con = getConnection("fixedasset");
            Statement stmt = getStatement();
            done = (stmt.executeUpdate(updatesql) != -1);

        } catch (Exception ex) {
            ex.printStackTrace();
        }
        finally{
             freeResource();
        }

        return done;

    }

    public boolean doEndofYear() {
        int f_start_year = getYear_start();
        int f_start_month = getMonth_start();
        int[] monthyear = getMonthYear();
        boolean done = false;
        boolean done1 = false;
        try {
            String[] findata = getFinancialInfo();
            java.util.Date stdate = sdf.parse(findata[0]);
            java.util.Date sysdate = new java.util.Date();
            System.out.println("System Month ===>" + monthyear[0]);
            System.out.println("System Year ===>" + monthyear[1]);
            System.out.println("financial Start Month  ===>" + f_start_month);
            System.out.println("financial Start Year ===>" + f_start_year);

            if (sysdate.after(stdate) || sysdate.equals(stdate)) {
                if (!checkMonthlyDep(stdate)) {
                    if (checkYearEndDepPerformed()) {

                        //Connection con = getConnection();
                        done = resetAssetDepytd();
                        done1 = resetFleetMasterValues();
                        archiveBudget();
                        updateYearEnd();
                    }
                }
            }
        } catch (Exception ex) {
            ex.printStackTrace();
        }
        finally{
             freeResource();
        }

        return (done == true && done1 == true);
    }

    public int getYear_start() {
        String sql =
                "select datepart(year, financial_start_date) AS SYEAR from am_gb_company";
        int syear = 0;
        try {
            //Connection con = getConnection("fixedasset");
            Statement stmt = getStatement();
            ResultSet rs = stmt.executeQuery(sql);
            while (rs.next()) {
                syear = rs.getInt("SYEAR");
            }
           // freeResource();
        } catch (Exception ex) {
            ex.printStackTrace();
        }
        finally{
             freeResource();
        }

        return syear;
    }

    /**
     *
     * @return int
     */
    public int getMonth_start() {
        String sql =
                "select datepart(month, financial_start_date) AS SMONTH from am_gb_company";
        int smonth = 0;
        try {
            //Connection con = getConnection("fixedasset");
            Statement stmt = getStatement();
            ResultSet rs = stmt.executeQuery(sql);
            while (rs.next()) {
                smonth = rs.getInt("SMONTH");
            }

        } catch (Exception ex) {
            ex.printStackTrace();
        }
        finally{
             freeResource();
        }

        return smonth;
    }

    public boolean checkMonthlyDep(java.util.Date finst) {
        System.out.println(
                "INFO-- checking monthly_depreciation_processing table");
        SimpleDateFormat sdff = new SimpleDateFormat("MM");
        SimpleDateFormat sdff2 = new SimpleDateFormat("yyyy");
        String sql =
            "SELECT * FROM month_depprocesing_summary WHERE datepart(month,DEP_DATE) >= " +
                sdff.format(dateFormat.dateConvert(finst)) +" AND "
                +" datepart(year,DEP_DATE) >= " +sdff2.format(dateFormat.dateConvert(finst));
        boolean exists = false;
         try {
            //Connection con = getConnection("fixedasset");
            Statement stmt = getStatement();
            ResultSet rs = stmt.executeQuery(sql);
            exists = rs.next();
            //freeResource();
        } catch (Exception ex) {
            ex.printStackTrace();
        }
        finally{
             freeResource();
        }

        return exists;

    }

    public boolean checkYearEndDepPerformed() {
        String sql =
                "select perform_year_end  from am_gb_company WHERE perform_year_end='N' ";
        boolean done = false;
        try {
            //Connection con = getConnection("fixedasset");
            Statement stmt = getStatement();
            ResultSet rs = stmt.executeQuery(sql);
            done = rs.next();
           // System.out.println("perform_year_end =======>" +
                               //rs.getString("perform_year_end"));
            //freeResource();
        } catch (Exception ex) {
            ex.printStackTrace();
        }
        finally{
             freeResource();
        }

        return done;

    }

    public int[] getMonthYear() {
        int[] monthyear = new int[2];

        java.util.Date d = new java.util.Date();
        java.text.SimpleDateFormat sd = new java.text.SimpleDateFormat(
                "dd/MM/yyyy");
        String datex = sd.format(d);
        System.out.println("system date =======>" + datex);
        StringTokenizer token = new StringTokenizer(datex, "/");
        while (token.hasMoreTokens()) {
            token.nextToken();
            monthyear[0] = Integer.parseInt(token.nextToken());
            monthyear[1] = Integer.parseInt(token.nextToken());
        }
        return monthyear;
    }

    public void archiveBudget() {
        System.out.println("INFO-- Archiving Old Budget");
        String[] dates = getFinancialInfo();
        String sql = "SELECT LT_ID,BRANCH_ID,BRANCH_NAME,CATEGORY,"
                     + "TOTAL_ALLOCATION,Q1_ALLOCATION,Q1_ACTUAL"
                     + ",Q2_ALLOCATION,Q2_ACTUAL,"
                     + "Q3_ALLOCATION,Q3_ACTUAL,Q4_ALLOCATION"
                     + " ,Q4_ACTUAL,BALANCE_ALLOCATION,TYPE"
                     + ",ACC_START_DATE,ACC_END_DATE"
                     + " FROM AM_ACQUISITION_BUDGET"
                     + " WHERE ACC_START_DATE<>'" +
                     dateFormat.dateConvert(dates[0]) + "' AND "
                     + " ACC_END_DATE<>'" + dateFormat.dateConvert(dates[2]) +
                     "'";
        String isql = "INSERT INTO AM_ACQUISITION_BUDGET_ARCHIVE"
                      + "(BRANCH_ID,BRANCH_NAME"
                      + ",CATEGORY,TOTAL_ALLOCATION"
                      + ",Q1_ALLOCATION,Q1_ACTUAL"
                      + ",Q2_ALLOCATION,Q2_ACTUAL"
                      + ",Q3_ALLOCATION,Q3_ACTUAL"
                      + ",Q4_ALLOCATION,Q4_ACTUAL"
                      + ",BALANCE_ALLOCATION,TYPE"
                      + ",ACC_START_DATE,ACC_END_DATE)"
                      + "  VALUES"
                      + "(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";

        try {
            //Connection con = getConnection("fixedasset");
            Statement stmt = getStatement();
            PreparedStatement ps = getConnection().prepareStatement(isql);
            ResultSet rs = stmt.executeQuery(sql);
            while (rs.next()) {
                String field0 = rs.getString("LT_ID");
                String field1 = rs.getString("BRANCH_ID");
                String field2 = rs.getString("BRANCH_NAME");
                String field3 = rs.getString("CATEGORY");
                String field4 = rs.getString("TOTAL_ALLOCATION");
                String field5 = rs.getString("Q1_ALLOCATION");
                String field6 = rs.getString("Q1_ACTUAL");
                String field7 = rs.getString("Q2_ALLOCATION");
                String field8 = rs.getString("Q2_ACTUAL");
                String field9 = rs.getString("Q3_ALLOCATION");
                String field10 = rs.getString("Q3_ACTUAL");
                String field11 = rs.getString("Q4_ALLOCATION");
                String field12 = rs.getString("Q4_ACTUAL");
                String field13 = rs.getString("BALANCE_ALLOCATION");
                String field14 = rs.getString("TYPE");
                String field15 = rs.getString("ACC_START_DATE");
                String field16 = rs.getString("ACC_END_DATE");

                // ps.setString(1, field0);
                ps.setString(1, field1);
                ps.setString(2, field2);
                ps.setString(3, field3);
                ps.setString(4, field4);
                ps.setString(5, field5);
                ps.setString(6, field6);
                ps.setString(7, field7);
                ps.setString(8, field8);
                ps.setString(9, field9);
                ps.setString(10, field10);
                ps.setString(11, field11);
                ps.setString(12, field12);
                ps.setString(13, field13);
                ps.setString(14, field14);
                ps.setString(15, field15);
                ps.setString(16, field16);

                ps.execute();

            }
            deleteOldBudget();
            //freeResource();
        } catch (Exception ex) {
            ex.printStackTrace();
        }
        finally{
             freeResource();
        }


    }

    public String[] getFinancialInfo() {
        String[] result = new String[3];

        String query = " SELECT financial_start_date,financial_no_ofmonths"
                       + ",financial_end_date"
                       + " FROM am_gb_company";

        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        try {
            con = getConnection();
            ps = con.prepareStatement(query);
            rs = ps.executeQuery();
            while (rs.next()) {
                result[0] = sdf.format(rs.getDate("financial_start_date"));
                result[1] = rs.getString("financial_no_ofmonths");
                result[2] = sdf.format(rs.getDate("financial_end_date"));

            }
        } catch (Exception e) {
            String warning = "WARNING:Error Fetching Company Details" +
                             " ->" + e.getMessage();
            System.out.println(warning);
        } finally {
            freeResource();
        }

        return result;
    }

    /**
     * deleteOldBudget
     */
    public void deleteOldBudget() {
        System.out.println("INFO-- Deleting Old Budget");
        String[] dates = getFinancialInfo();
        String sql = "DELETE FROM AM_ACQUISITION_BUDGET"
                     + " WHERE ACC_START_DATE<>'" +
                     dateFormat.dateConvert(dates[0]) + "' AND "
                     + " ACC_END_DATE<>'" + dateFormat.dateConvert(dates[2]) +
                     "'";
        Connection con = null;
        PreparedStatement ps = null;

        try {
            con = getConnection();
            ps = con.prepareStatement(sql);
            ps.execute();
        } catch (Exception e) {
            String warning = "WARNING:Error Fetching Company Details" +
                             " ->" + e.getMessage();
            System.out.println(warning);
        } finally {
            freeResource();
        }

    }
    public void updateYearEnd() {
           Connection con = null;
           ResultSet rs = null;
           PreparedStatement ps = null;
           String query = "UPDATE AM_GB_COMPANY SET  perform_year_end = 'Y'";
           try {
               con = getConnection();
               ps = con.prepareStatement(query);
               rs = ps.executeQuery();
           } catch (Exception ex) {
               System.out.println("WARN: Error updateing perform_year_end->" +
                                  ex.getMessage());
           } finally {
               freeResource();
           }

    }
}
