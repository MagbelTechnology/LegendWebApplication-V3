package magma.net.manager;

import java.text.SimpleDateFormat;
import java.sql.*;
import java.util.*;

import magma.net.dao.MagmaDBConnection;
import magma.net.vao.AssetPayment;
import magma.net.vao.GroupAssets;

public class GroupAssetPaymentManager extends MagmaDBConnection {
	SimpleDateFormat sdf;

	public GroupAssetPaymentManager() {
		super();
		sdf = new SimpleDateFormat("dd-MM-yyyy");
	}

	public boolean createPaymentRecord(String assetId, double pay,
			String payDate, String raised, String payDesc) {

		String INSERT_QUERY = "INSERT INTO AM_ASSET_PAYMENT "
				+ "(ASSET_ID,PAYMENT,PAY_DATE,RAISED,PAY_DESC,TYPE) "
				+ "VALUES(?,?,?,?,?,?)";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(INSERT_QUERY);
			ps.setString(1, assetId);
			ps.setDouble(2, pay);
			ps.setDate(3, dateConvert(payDate));
			ps.setString(4, raised);
			ps.setString(5, payDesc);
			ps.setString(6, "G");
			done = (ps.executeUpdate() != -1);
			notifyAsset(assetId, pay);
			// notifyGroupAssets(assetId,pay);
			notifyGroup(assetId, pay);

		} catch (Exception ex) {

		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	public boolean updatePaymentRecord(double pay, double ppay, String payDesc, String payId, String assetid) {

		String UPDATE_QUERY = "UPDATE AM_ASSET_PAYMENT "
				+ "SET PAYMENT=?,PAY_DESC=? WHERE PAY_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);

			ps.setDouble(1, pay);
			// ps.setString(2, raised);
			ps.setString(2, payDesc);
			ps.setString(3, payId);

			done = (ps.executeUpdate() != -1);
			notifyuAsset(assetid, pay, ppay);

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	public boolean raisePaymentRecord(String payId) {

		String UPDATE_QUERY = "UPDATE AM_ASSET_PAYMENT "
				+ " SET RAISED=? WHERE PAY_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);

			ps.setString(1, "R");
			ps.setString(2, payId);

			done = (ps.executeUpdate() != -1);

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}
	
	public boolean raiseGRecord(String payId) {

		String UPDATE_QUERY = "UPDATE AM_GROUP_ASSET_MAIN "
				+ " SET RAISE_ENTRY=? WHERE GROUP_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);

			ps.setString(1, "R");
			ps.setString(2, payId);

			done = (ps.executeUpdate() != -1);

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	public boolean isRaised(String payId) {

		String QUERY = "SELECT  RAISED FROM AM_ASSET_PAYMENT "
				+ " WHERE PAY_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(QUERY);
			ps.setString(1, payId);

			rs = ps.executeQuery();
			while (rs.next()) {
				done = (rs.getString("RAISED") == "R");
			}

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	private ArrayList<AssetPayment> findPayments(String filter) {
		ArrayList<AssetPayment> found = new ArrayList<AssetPayment>();
		AssetPayment pay = null;
		String QUERY = "SELECT PAY_ID,ASSET_ID,PAYMENT,PAY_DATE,"
				+ "RAISED,PAY_DESC FROM AM_ASSET_PAYMENT WHERE TYPE='G' ";
		QUERY += filter;
		Connection con = null;
		PreparedStatement ps = null;
		ResultSet rs = null;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(QUERY);
			rs = ps.executeQuery();
			while (rs.next()) {

				String assetId = rs.getString("ASSET_ID");
				double payment = rs.getDouble("PAYMENT");
				String payDate = sdf.format(rs.getDate("PAY_DATE"));
				String raised = rs.getString("RAISED");
				String payDesc = rs.getString("PAY_DESC");
				String payId = rs.getString("PAY_ID");

				pay = new AssetPayment(assetId, payment, payDate, raised,
						payDesc);
				pay.setPayId(payId);

				found.add(pay);
			}

		} catch (Exception ex) {

		} finally {
			closeConnection(con, ps);
		}

		return found;

	}

	public ArrayList<AssetPayment> findPaymentsByAssetID(String assetId) {
		ArrayList<AssetPayment> found = new ArrayList<AssetPayment>();
		String filter = " AND ASSET_ID ='" + assetId + "'";
		found = findPayments(filter);
		return found;
	}

	public AssetPayment findPaymentsByPayID(String payId) {
		AssetPayment found = null;
		String filter = " AND PAY_ID =" + payId;
		found = findPayments(filter).get(0);
		return found;
	}

	public ArrayList<AssetPayment> findPaymentsByQuery(String criterium) {
		ArrayList<AssetPayment> found = new ArrayList<AssetPayment>();
		String filter = " AND PAY_ID IS NOT NULL " + criterium;
		found = findPayments(filter);
		return found;
	}

	public boolean notifyAsset(String assetId, double pay) {

		String UPDATE_QUERY = "UPDATE AM_ASSET "
				+ " SET AMOUNT_PTD=AMOUNT_PTD+?,AMOUNT_REM=AMOUNT_REM-?, "
				+ "FULLY_PAID=? WHERE GROUP_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);
			String paid = "N";
			if (isFullyPaid(assetId)) {
				paid = "Y";
			}

			ps.setDouble(1, pay);
			ps.setDouble(2, pay);
			ps.setString(3, paid);
			ps.setString(4, assetId);

			done = (ps.executeUpdate() != -1);

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}
	
	public boolean notifyuAsset(String assetId,double pay,double ppay) {

		String UPDATE_QUERY = "UPDATE AM_ASSET "
				+ " SET AMOUNT_PTD=AMOUNT_PTD-?,AMOUNT_REM=AMOUNT_REM+?, " +
						"FULLY_PAID=? WHERE GROUP_ID=? ";
		
		String UPDATE_QUERY2 = "UPDATE AM_ASSET "
			+ " SET AMOUNT_PTD=AMOUNT_PTD+?,AMOUNT_REM=AMOUNT_REM-?, " +
					"FULLY_PAID=? WHERE GROUP_ID=? ";
		
		String UPDATE_QUERY3 = "UPDATE AM_GROUP_ASSET_MAIN "
			+ " SET AMOUNT_PTD=AMOUNT_PTD+?,AMOUNT_REM=AMOUNT_REM-?, " +
					"FULLY_PAID=? WHERE GROUP_ID=? ";
		
		String UPDATE_QUERY25 = "UPDATE AM_ASSET "
			+ " SET AMOUNT_PTD=AMOUNT_PTD-?,AMOUNT_REM=AMOUNT_REM+?, " +
					"FULLY_PAID=? WHERE GROUP_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);
		String paid="N";
		if(isFullyPaid(assetId)){ paid="Y";}
		
			ps.setDouble(1, ppay);
			ps.setDouble(2, ppay);
			ps.setString(3, paid);
			ps.setString(4, assetId);

			done = (ps.executeUpdate() != -1);
			
			ps = con.prepareStatement(UPDATE_QUERY2);
			ps.setDouble(1, pay);
			ps.setDouble(2, pay);
			ps.setString(3, paid);
			ps.setString(4, assetId);

			done = (ps.executeUpdate() != -1);
			
			ps = con.prepareStatement(UPDATE_QUERY25);
			
			
				ps.setDouble(1, ppay);
				ps.setDouble(2, ppay);
				ps.setString(3, paid);
				ps.setString(4, assetId);
			
			ps = con.prepareStatement(UPDATE_QUERY3);
			ps.setDouble(1, pay);
			ps.setDouble(2, pay);
			ps.setString(3, paid);
			ps.setString(4, assetId);

			done = (ps.executeUpdate() != -1);

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	public boolean notifyRAsset(String assetId) {

		String UPDATE_QUERY = "UPDATE AM_ASSET "
				+ " SET RAISE_ENTRY='R' WHERE GROUP_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);

			ps.setString(1, assetId);

			done = (ps.executeUpdate() != -1);

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	public boolean deleteGAsset(String assetId, String groupid) {

		String UPDATE_QUERY = "DELETE FROM AM_GROUP_ASSET "
				+ "  WHERE ASSET_ID=? ";

		String UPDATE_QUERY2 = "UPDATE  AM_GROUP_ASSET_MAIN "
				+ " SET QUANTITY = QUANTITY-1, Cost_Price=(Cost_Price-Cost_Price/QUANTITY)," +
						"Vatable_Cost=(Vatable_Cost-Vatable_Cost/QUANTITY) WHERE GROUP_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);
			ps.setString(1, assetId);
			done = (ps.executeUpdate() != -1);

			ps = con.prepareStatement(UPDATE_QUERY2);
			ps.setString(1, groupid);
			done = (ps.executeUpdate() != -1);

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	public boolean notifyGroup(String assetId, double pay) {

		String UPDATE_QUERY = "UPDATE AM_GROUP_ASSET_MAIN  "
				+ " SET AMOUNT_PTD=AMOUNT_PTD+?,AMOUNT_REM=AMOUNT_REM-?, "
				+ "FULLY_PAID=? WHERE GROUP_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);
			String paid = "N";
			if (isFullyPaid(assetId)) {
				paid = "Y";
			}

			ps.setDouble(1, pay);
			ps.setDouble(2, pay);
			ps.setString(3, paid);
			ps.setString(4, assetId);

			done = (ps.executeUpdate() != -1);

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	public boolean notifyRGroup(String assetId) {

		String UPDATE_QUERY = "UPDATE AM_GROUP_ASSET_MAIN  "
				+ " SET RAISED_ENTRY='R' WHERE GROUP_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);

			ps.setString(1, assetId);

			done = (ps.executeUpdate() != -1);

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	public boolean isFullyPaid(String assetId) {

		String UPDATE_QUERY = "SELECT DISTINCT AMOUNT_REM FROM AM_ASSET "
				+ " WHERE GROUP_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);
			ps.setString(1, assetId);
			while (rs.next()) {
				rs = ps.executeQuery();
				done = (rs.getDouble("AMOUNT_REM") == 0.);
			}

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

	public ArrayList<GroupAssets> findGroupMainAssetByQuery(String queryFilter) {

		Connection con = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		GroupAssets groupAsset = null;
		ArrayList<GroupAssets> finder = new ArrayList<GroupAssets>();
		String selectQuery = "SELECT group_id, quantity, Registration_No, "
				+ "Branch_ID, Dept_ID, Category_ID, section_id, Description, "
				+ "Vendor_AC, Date_purchased, dep_rate, asset_make, asset_model, "
				+ "asset_serial_no, asset_engine_no, supplier_name, asset_user, "
				+ "asset_maintenance, Cost_Price, dep_end_date, residual_value, "
				+ "authorized_by, wh_tax, wh_tax_amount, req_redistribution, "
				+ "Posting_Date, effective_date, purchase_reason, location, "
				+ "Vatable_Cost, Vat, Req_Depreciation, Subject_TO_Vat, "
				+ "Who_TO_Rem, email1, who_to_rem_2, email2, Raise_entry, "
				+ "dep_ytd, Section, Asset_Status, state, driver, spare_1, "
				+ "spare_2, user_ID, province, WAR_START_DATE, WAR_MONTH, "
				+ "WAR_EXPIRY_DATE, branch_code, dept_code, section_code, "
				+ "category_code,AMOUNT_PTD,AMOUNT_REM,PART_PAY,FULLY_PAID "
				+ " FROM am_group_asset_main " + queryFilter;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(selectQuery);
			rs = ps.executeQuery();

			while (rs.next()) {
				groupAsset = new GroupAssets();
				groupAsset.setGid(rs.getLong("GROUP_ID"));
				groupAsset.setAmountPTD(rs.getString("AMOUNT_PTD"));
				groupAsset.setAmountREM(rs.getString("AMOUNT_REM"));
				groupAsset.setCategory_id(rs.getString("Category_ID"));
				groupAsset.setCost_price(rs.getString("cost_price"));
				groupAsset.setDate_of_purchase(sdf.format(rs
						.getDate("Date_purchased")));
				groupAsset.setDepartment_id(rs.getString("Dept_ID"));
				groupAsset.setDescription(rs.getString("description"));
				groupAsset.setFullyPAID(rs.getString("FULLY_PAID"));
				groupAsset.setLocation(rs.getString("location"));
				groupAsset.setMake(rs.getString("asset_make"));
				groupAsset.setModel(rs.getString("asset_model"));
				groupAsset.setPartPAY(rs.getString("PART_PAY"));
				groupAsset.setPosting_date(sdf.format(rs
						.getDate("posting_date")));
				groupAsset.setProvince(rs.getString("province"));
				groupAsset.setQuantity(rs.getInt("quantity"));
				groupAsset.setBranch_id(rs.getString("Branch_ID"));
				groupAsset.setSection_id(rs.getString("section_id"));
				groupAsset.setState(rs.getString("state"));
				groupAsset.setVendor_account(rs.getString("Vendor_AC"));
				groupAsset.setVat_amount(rs.getString("Vat"));
				groupAsset.setWh_tax_amount(rs.getString("wh_tax_amount"));
				groupAsset.setVatable_cost(rs.getString("Vatable_Cost"));
				groupAsset.setRaise_entry(rs.getString("Raise_entry"));
				groupAsset.setUser_id(rs.getString("user_id"));
				finder.add(groupAsset);

			}

		} catch (Exception e) {
			System.out.println("INFO:Error Fetching GroupAsset Records ->"
					+ e.getMessage());
		} finally {
			closeConnection(con, ps, rs);
		}
		return finder;
	}

	
	public boolean isAssetMoved(String assetId) {

		String UPDATE_QUERY = "SELECT COUNT(*) FROM AM_GROUP_ASSET "
				+ " WHERE GROUP_ID=? ";

		Connection con = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		boolean done = false;

		try {
			con = getConnection("fixedasset");
			ps = con.prepareStatement(UPDATE_QUERY);
			ps.setString(1, assetId);
			rs = ps.executeQuery();
			while (rs.next()) {
				done = (rs.getInt(1) > 0);
			}

		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			closeConnection(con, ps);
		}
		return done;
	}

}
