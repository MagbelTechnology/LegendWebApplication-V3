/*
 * Festus Jejelowo
 *
 * Copyright (c) 2005-2006 MagBel Technology LTD. All Rights Reserved.
 *
 * This software is the confidential and proprietary information of MagBel
 * Technology LTD. ("Confidential Information"). You shall not
 * disclose such Confidential Information and shall use it only in
 * accordance with the terms of the license agreement you entered into
 * with Magbel.
 *
 * MAGBEL MAKES NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY OF
 * THE SOFTWARE, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED
 * TO THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 * PARTICULAR PURPOSE, OR NON-INFRINGEMENT. SUN SHALL NOT BE LIABLE FOR
 * ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, MODIFYING OR
 * DISTRIBUTING THIS SOFTWARE OR ITS DERIVATIVES.
 */

package magma.net.manager;

import java.sql.*;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;

import com.magbel.util.CurrencyNumberformat;
import magma.net.dao.MagmaDBConnection;
import magma.net.vao.*;

/**
 * <p>Title: FleetBudgetManager.java</p>
 *
 * <p>Description: File Description</p>
 *
 * <p>Copyright: Copyright (c) 2006</p>
 *
 * <p>Company: Magbel Technologies LTD</p>
 *
 * @author Jejelowo.B.Festus
 * @version 1.0
 * @see magma.net.dao.MagmaDBConnection
 */
public class FleetBudgetManager extends MagmaDBConnection {
    /**
     * affectedRow int
     * No of rows processing affected.
     */
    private int affectedRow;
    private boolean tranSucessful;

    private CurrencyNumberformat formata;
    private SimpleDateFormat sdf;

    public FleetBudgetManager() {
        sdf = new SimpleDateFormat("dd-MM-yyyy");
        formata = new CurrencyNumberformat();
    }

    public void setAffectedRow(int affectedRow) {
        this.affectedRow = affectedRow;
    }

    public void setTranSucessful(boolean tranSucessful) {
        this.tranSucessful = tranSucessful;
    }

    public int getAffectedRow() {
        return affectedRow;
    }

    public boolean isTranSucessful() {
        return tranSucessful;
    }

    public void allocateQauertMaintenanceBudget(String categoryCode,
                                                String makeCode,
                                                double formYearBelow1,
                                                double formYearLG2,
                                                double formYearLG3,
                                                double formYearLG4,
                                                double formYearAbove4,
                                                int QAUTER_TYPE) {

        FleetHistoryManager fleetHistory = new FleetHistoryManager();
        ArrayList list = fleetHistory.findAssetByMakeCategory(categoryCode,
                makeCode);
        String financialStartDate = getFinancialStartDate();
        int columnCode = 0;

        for (int x = 0; x < list.size(); x++) {
            Asset aset = (Asset) list.get(x);

            String id = "";
            String assetId = aset.getId();
            String assetName = aset.getDescription();
            String make = makeCode;
            String category = aset.getCategory();
            String purchaseDate = aset.getDatePurchased();
            int age = calculateAssetAge(financialStartDate, purchaseDate);

            double yearBelow1 = 0.00d;
            double yearLG2 = 0.00d;
            double yearLG3 = 0.00d;
            double yearLG4 = 0.00d;
            double yearAbove4 = 0.00d;

            double allocatedAmount = 0.00d;

            if (age < 12) {
                allocatedAmount = formYearBelow1; //Less than 1year
                columnCode = 1;
            } else if (age > 12 && (age < 24 || age == 24)) {
                allocatedAmount = formYearLG2; // 1 < age <= 2years
                columnCode = 2;
            } else if (age > 24 && (age < 36 || age == 36)) {
                allocatedAmount = formYearLG3; // 2 < age <= 3years
                columnCode = 3;
            } else if (age > 36 && (age < 48 || age == 48)) {
                allocatedAmount = formYearLG4; // 3 < age <= 4 years
                columnCode = 4;
            } else {
                allocatedAmount = formYearAbove4; // above 4 years
                columnCode = 5;
            }
            logQaurterlyBudgetTransaction(assetId, allocatedAmount, QAUTER_TYPE);
        }

    }


    /**
     * copyBudgetToAll
     *
     * @param categoryCode String
     * @param makeCode String
     */
    public void allocateMaintenanceBudget(String categoryCode, String makeCode,
                                          double formYearBelow1,
                                          double formYearLG2,
                                          double formYearLG3,
                                          double formYearLG4,
                                          double formYearAbove4, String userid) {

        FleetHistoryManager fleetHistory = new FleetHistoryManager();
        AssetMakeAllocation makeAllocation = new AssetMakeAllocation("",
                "", "",
                makeCode, "", categoryCode, formYearBelow1, formYearLG2,
                formYearLG3,
                formYearLG4, formYearAbove4);
        allocateBudget(makeAllocation, userid);

        ArrayList list = fleetHistory.findAssetByMakeCategory(categoryCode,
                makeCode);
        String financialStartDate = getFinancialStartDate();
        int columnCode = 0;

        for (int x = 0; x < list.size(); x++) {
            Asset aset = (Asset) list.get(x);

            String id = "";
            String assetId = aset.getId();
            String assetName = aset.getDescription();
            String make = makeCode;
            String category = aset.getCategory();
            String purchaseDate = aset.getDatePurchased();
            int age = calculateAssetAge(financialStartDate, purchaseDate);

            double yearBelow1 = 0.00d;
            double yearLG2 = 0.00d;
            double yearLG3 = 0.00d;
            double yearLG4 = 0.00d;
            double yearAbove4 = 0.00d;

            double allocatedAmount = 0.00d;

            if (age < 12) {
                allocatedAmount = formYearBelow1; //Less than 1year
                columnCode = 1;
            } else if (age > 12 && (age < 24 || age == 24)) {
                allocatedAmount = formYearLG2; // 1 < age <= 2years
                columnCode = 2;
            } else if (age > 24 && (age < 36 || age == 36)) {
                allocatedAmount = formYearLG3; // 2 < age <= 3years
                columnCode = 3;
            } else if (age > 36 && (age < 48 || age == 48)) {
                allocatedAmount = formYearLG4; // 3 < age <= 4 years
                columnCode = 4;
            } else {
                allocatedAmount = formYearAbove4; // above 4 years
                columnCode = 5;
            }
            logAnnualMaintenanceBudgetTransaction(assetId, allocatedAmount);
        }
    }

    private int calculateAssetAge(String financialStartDate,
                                  String purchaseDate) {
        int monthDifference = 0;
        SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");

        Date finDate = null;
        Date purDate = null;

        try {
            finDate = sdf.parse(financialStartDate);
            purDate = sdf.parse(purchaseDate);

            long longFinDate = finDate.getTime();
            long longPurDate = purDate.getTime();

            long dateDiff = longFinDate - longPurDate;
            long yearMonth = (long) 1000 * 60 * 60 * 24 * 365;
            monthDifference = ((int) ((dateDiff / yearMonth))) * 12;

        } catch (Exception e) {
            System.out.println("WARNING :Error calculating Asset Age ->" +
                               e.getMessage());
        }

        return monthDifference;
    }

    /**
     * allocateBudget
     *
     * @param makeAllocation AssetMakeAllocation
     * @see <a href = "../vao/AssetMakeAllocation.html">magma.net.vao.AssetMakeAllocation</href>
     */
    public void allocateMaintenanceBudget(AssetMakeAllocation makeAllocation) {

        Connection con = null;
        PreparedStatement ps = null;
        String query = "INSERT INTO AM_MAINTENANCE_BUDGET(" +
                       "ASSET_ID,ASSET_DESC,ASSET_MAKE," +
                       "MAKE_CODE,CATEGORY,YEAR_BELOW1,YEAR_BETWEEN2," +
                       "YEAR_BETWEEN3,YEAR_BETWEEN4,YEAR_ABOVE4,ACC_START_DATE," +
                       "ACC_END_DATE)  " +
                       "VALUES (?,?,?,?,?,?,?,?,?,?,?,?)";
        String[] financialDates = this.getFinancialDates();
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);

            ps.setString(1, makeAllocation.getAssetId());
            ps.setString(2, makeAllocation.getAssetName());
            ps.setString(3, makeAllocation.getMake());
            ps.setString(4, makeAllocation.getMakeCode());
            ps.setString(5, makeAllocation.getCategory());
            ps.setDouble(6, makeAllocation.getYearBelow1());
            ps.setDouble(7, makeAllocation.getYearLG2());
            ps.setDouble(8, makeAllocation.getYearLG3());
            ps.setDouble(9, makeAllocation.getYearLG4());
            ps.setDouble(10, makeAllocation.getYearAbove4());
            ps.setDate(11, dateConvert(financialDates[0]));
            ps.setDate(12, dateConvert(financialDates[1]));

            ps.execute();

        } catch (Exception e) {
            System.out.println("INFO:Error allocating Maintenance Budget ->" +
                               e.getMessage());
            setAffectedRow(affectedRow - 1);
        } finally {
            closeConnection(con, ps);
        }

    }

    public void allocateBudget(AssetMakeAllocation makeAllocation,
                               String userid) {

        Connection con = null;
        PreparedStatement ps = null;
        String query = "INSERT INTO AM_MAINTENANCE_BUDGET(" +
                       "MAKE_CODE,CATEGORY,YEAR_BELOW1,YEAR_BETWEEN2," +
                       "YEAR_BETWEEN3,YEAR_BETWEEN4,YEAR_ABOVE4,ACC_START_DATE," +
                       "ACC_END_DATE,USER_ID)  " +
                       "VALUES (?,?,?,?,?,?,?,?,?,?)";
        String[] financialDates = this.getFinancialDates();
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);

            ps.setString(1, makeAllocation.getMakeCode());
            ps.setString(2, makeAllocation.getCategory());
            ps.setDouble(3, makeAllocation.getYearBelow1());
            ps.setDouble(4, makeAllocation.getYearLG2());
            ps.setDouble(5, makeAllocation.getYearLG3());
            ps.setDouble(6, makeAllocation.getYearLG4());
            ps.setDouble(7, makeAllocation.getYearAbove4());
            ps.setDate(8, dateConvert(financialDates[0]));
            ps.setDate(9, dateConvert(financialDates[1]));
            ps.setString(10, userid);

            ps.execute();

        } catch (Exception e) {
            System.out.println("INFO:Error allocating Maintenance Budget ->" +
                               e.getMessage());
            setAffectedRow(affectedRow - 1);
        } finally {
            closeConnection(con, ps);
        }

    }


    public void allocateFuelBudget(String category, String makeCode,
                                   String location, double amount) {
        String[] finDates = this.getFinancialDates();
        logFuelTransaction(category, makeCode, location, amount,
                           finDates[0]);
        copyFuelBudgetToAll(category, makeCode, location, amount);
    }

    private void logFuelTransaction(String category, String makeCode,
                                    String location,
                                    double amount, String financialStartDate) {
        Connection con = null;
        PreparedStatement ps = null;
        String query = "INSERT INTO AM_FUEL_BUDGET(" +
                       "MAKE_CODE,CATEGORY,AMOUNT,FIN_START_DATE,LOCATION)  " +
                       "VALUES (?,?,?,?,?)";

        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);

            ps.setString(1, makeCode);
            ps.setString(2, category);
            ps.setDouble(3, amount);
            ps.setDate(4, dateConvert(financialStartDate));
            ps.setString(5, location);

            ps.execute();

        } catch (Exception e) {
            System.out.println("INFO:Error allocating Fuel Budget ->" +
                               e.getMessage());
            setAffectedRow(affectedRow - 1);
        } finally {
            closeConnection(con, ps);
        }

    }

    public void copyFuelBudgetToAll(String category, String makeCode,
                                    String location, double amount) {
        Connection con = null;
        PreparedStatement ps = null;
        String query = "UPDATE FT_FLEET_MASTER " +
                       "SET FUEL_BUDGET = FUEL_BUDGET + ?  " +
                       "WHERE ASSET_MAKE = ? AND LOCATION = ? " +
                       "AND CATEGORY_ID = ? ";

        try {

            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);
            ps.setDouble(1, amount);
            ps.setString(2, makeCode);
            ps.setString(3, location);
            ps.setInt(4, Integer.parseInt(category));

            int affectedRows = ps.executeUpdate();
            this.setAffectedRow(affectedRows);

        } catch (Exception e) {
            System.out.println("INFO:Error allocating Copying Fuel Budget ->" +
                               e.getMessage());
            setAffectedRow(affectedRow - 1);
        } finally {
            closeConnection(con, ps);
        }

    }

    private void logAnnualMaintenanceBudgetTransaction(String assetid,
            double amount) {
        Connection con = null;
        PreparedStatement ps = null;
        String query = "UPDATE FT_FLEET_MASTER    " +
                       "SET MAINT_BUDGET =  MAINT_BUDGET + ? " +
                       "WHERE ASSET_ID = ?";

        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);

            ps.setDouble(1, amount);
            ps.setString(2, assetid);

            ps.execute();

        } catch (Exception e) {
            System.out.println(
                    "INFO:Error logging AnnualMaintenanceBudgetTransaction ->" +
                    e.getMessage());
            setAffectedRow(affectedRow - 1);
        } finally {
            closeConnection(con, ps);
        }

    }


    private void logQaurterlyBudgetTransaction(String assetid,
                                               double quarterAmount,
                                               int quaterType) {
        Connection con = null;
        PreparedStatement ps = null;

        String amountColumn = "";
        if (quaterType == 1) {
            amountColumn = " MAINT_Q1 = MAINT_Q1 + ?  ";
        } else if (quaterType == 2) {
            amountColumn = " MAINT_Q2 = MAINT_Q2 + ?  ";
        } else if (quaterType == 3) {
            amountColumn = " MAINT_Q3 = MAINT_Q3 + ?  ";
        } else {
            amountColumn = " MAINT_Q4 = MAINT_Q4 + ?  ";
        }

        String query = "UPDATE FT_FLEET_MASTER    " +
                       "SET " + amountColumn +
                       " ,MAINT_BUDGET = MAINT_BUDGET + ?  " +
                       "WHERE ASSET_ID = ?";

        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);

            ps.setDouble(1, quarterAmount);
            ps.setDouble(2, quarterAmount);
            ps.setString(3, assetid);

            ps.execute();
            setAffectedRow(affectedRow + 1);
        } catch (Exception e) {
            System.out.println(
                    "INFO:Error logging QaurterlyBudgetTransaction ->" +
                    e.getMessage());
            setAffectedRow(affectedRow - 1);
        } finally {
            closeConnection(con, ps);
        }

    }


    /**
     * allocateBudget
     *
     * @param branchCode String
     * @param branchName String
     * @param firstQuaterAmount double
     * @param secondQuaterAmount double
     * @param thirdQuaterAmount double
     * @param totalAmount double
     * @param balanceAmount double
     */
    public void allocateBudget(String branchCode, String branchName,
                               String category, double firstQuaterAmount,
                               double secondQuaterAmount,
                               double thirdQuaterAmount,
                               double fourthQuaterAmount,
                               double totalAmount,
                               double balanceAmount, String type) {
        Connection con = null;
        PreparedStatement ps = null;
        String createQuery = "INSERT INTO AM_ACQUISITION_BUDGET(" +
                             "BRANCH_ID,BRANCH_NAME,TOTAL_ALLOCATION," +
                             "Q1_ALLOCATION,Q2_ALLOCATION,Q3_ALLOCATION," +
                             "Q4_ALLOCATION,BALANCE_ALLOCATION,TYPE," +
                             "CATEGORY,ACC_START_DATE,ACC_END_DATE) " +
                             " VALUES(?,?,?,?,?,?,?,?,?,?,?,?)";
        String[] financialDates = this.getFinancialDates();
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(createQuery);
            ps.setString(1, branchCode);
            ps.setString(2, branchName);
            ps.setDouble(3, totalAmount);
            ps.setDouble(4, firstQuaterAmount);
            ps.setDouble(5, secondQuaterAmount);
            ps.setDouble(6, thirdQuaterAmount);
            ps.setDouble(7, fourthQuaterAmount);
            ps.setDouble(8, balanceAmount);
            ps.setString(9, type);
            ps.setString(10, category);
            ps.setDate(11, dateConvert(financialDates[0]));
            ps.setDate(12, dateConvert(financialDates[1]));

            ps.execute();

        } catch (Exception e) {
            System.out.println("INFO:Error allocating Budget ->" + e.getMessage());
        } finally {
            closeConnection(con, ps);
        }

    }

    /**
     * updateBudget
     *
     * @param branchCode String
     * @param firstQauterAmount double
     * @param secondQuaterAmount double
     * @param thirdQuaterAmount double
     * @param totalAmount double
     * @param balanceAmount double
     *  @param type String
     */
    public void updateBudget(String id, double firstQauterAmount,
                             double secondQuaterAmount,
                             double thirdQuaterAmount, double totalAmount,
                             double fourthQuarterAmount, double balanceAmount
            ) {

        String updateQuery = " UPDATE AM_ACQUISITION_BUDGET " +
                             "SET TOTAL_ALLOCATION = ?,Q1_ALLOCATION = ?," +
                             "Q2_ALLOCATION = ?,Q3_ALLOCATION = ?," +
                             "Q4_ALLOCATION = ?, BALANCE_ALLOCATION = ? " +
                             " WHERE LT_ID = ?";
        Connection con = null;
        PreparedStatement ps = null;
        String createQuery = "";

        try {

            con = getConnection("fixedasset");
            ps = con.prepareStatement(createQuery);
            ps.setDouble(1, totalAmount);
            ps.setDouble(2, firstQauterAmount);
            ps.setDouble(3, secondQuaterAmount);
            ps.setDouble(4, thirdQuaterAmount);
            ps.setDouble(5, fourthQuarterAmount);
            ps.setDouble(6, balanceAmount);
            ps.setInt(7, Integer.parseInt(id));

            ps.execute();

        } catch (Exception e) {
            System.out.println("INFO:Error updating Budget ->" + e.getMessage());
        } finally {
            closeConnection(con, ps);
        }
    }

    public boolean isDuplicateAcquisitionEntry(String branchCode,
                                               String category) {
        boolean isDuplicate = false;
        String searchQuery = "SELECT COUNT(TOTAL_ALLOCATION)    " +
                             "FROM AM_ACQUISITION_BUDGET   " +
                             "Where BRANCH_ID = ? and CATEGORY = ?";

        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

        try {

            con = getConnection("fixedasset");
            ps = con.prepareStatement(searchQuery);
            ps.setString(1, branchCode);
            ps.setString(2, category);
            rs = ps.executeQuery();

            while (rs.next()) {
                int Counter = rs.getInt(1);
                if (Counter > 0) {
                    isDuplicate = true;
                }
            }

        } catch (Exception e) {
            System.out.println("WARNING:Error checking for duplicate entry ->" +
                               e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }
        return isDuplicate;

    }

    public boolean isDuplicateMaintenanceEntry(String makeCode, String category) {
        boolean isDuplicate = false;
        String searchQuery = "SELECT COUNT(TOTAL_ALLOCATION)    " +
                             "FROM AM_ACQUISITION_BUDGET   " +
                             "Where BRANCH_ID = ? and CATEGORY = ?";

        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

        try {

            con = getConnection("fixedasset");
            ps = con.prepareStatement(searchQuery);
            ps.setString(1, makeCode);
            ps.setString(2, category);
            rs = ps.executeQuery();

            while (rs.next()) {
                int Counter = rs.getInt(1);
                if (Counter > 0) {
                    isDuplicate = true;
                }
            }

        } catch (Exception e) {
            System.out.println("WARNING:Error checking for duplicate entry ->" +
                               e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }
        return isDuplicate;

    }


    /**
     * findAllBranchAllocation
     *
     * @return ArrayList
     */
    public ArrayList findAllBranchAllocation() {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        ArrayList list = new ArrayList();
        String selectQuery = "SELECT BRANCH_ID,BRANCH_NAME," +
                             "SUM(TOTAL_ALLOCATION) AS TOTAL_ALLOCATION," +
                             "SUM(Q1_ALLOCATION) AS Q1_ALLOCATION," +
                             "SUM(Q2_ALLOCATION) AS Q2_ALLOCATION," +
                             "SUM(Q3_ALLOCATION) AS Q3_ALLOCATION," +
                             "SUM(Q4_ALLOCATION) AS Q4_ALLOCATION," +
                             "SUM(BALANCE_ALLOCATION) AS BALANCE_ALLOCATION   " +
                             "FROM AM_ACQUISITION_BUDGET  " +
                             "GROUP BY BRANCH_ID, BRANCH_NAME ORDER BY BRANCH_NAME";

        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            rs = ps.executeQuery();

            while (rs.next()) {

                String id = "";
                String branchCode = rs.getString("BRANCH_ID");
                String branchName = rs.getString("BRANCH_NAME");
                double firstQauterAmount = rs.getDouble("Q1_ALLOCATION");
                double secondQuaterAmount = rs.getDouble("Q2_ALLOCATION");
                double thirdQauterAmount = rs.getDouble("Q3_ALLOCATION");
                double fourthQauterAmount = rs.getDouble("Q4_ALLOCATION");
                double totalAmount = rs.getDouble("TOTAL_ALLOCATION");
                double balanceAmount = rs.getDouble("BALANCE_ALLOCATION");
                String type = "";

                BranchAllocation allocation = new BranchAllocation(id,
                        branchCode,
                        branchName, firstQauterAmount, secondQuaterAmount,
                        thirdQauterAmount, fourthQauterAmount,
                        totalAmount, balanceAmount,
                        type);
                list.add(allocation);
            }

        } catch (Exception e) {
            System.out.println("INFO:Error fetching all Budget allocations ->" +
                               e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return list;

    }

    public ArrayList findFuelAllocationByMakeCategory(String assetMake,
            String category) {
        ArrayList finder = new ArrayList();
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        ArrayList list = new ArrayList();
        String selectQuery =
                "SELECT LT_ID,ASSET_ID,ASSET_DESC,ASSET_MAKE,MAKE_CODE," +
                "CATEGORY,AMOUNT,UPPER(LOCATION) AS LOCATION,FIN_START_DATE   " +
                "FROM AM_FUEL_BUDGET     " +
                "WHERE ASSET_MAKE = ? AND CATEGORY = ?  ";

        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            ps.setString(1, assetMake);
            ps.setString(2, category);
            rs = ps.executeQuery();

            while (rs.next()) {
                String id = rs.getString("LT_ID");
                int categoryCount = 0;
                String location = rs.getString("LOCATION");
                String financialStartDate = rs.getString("FIN_START_DATE");
                double amount = rs.getDouble("AMOUNT");

                FuelAllocation allocation = new FuelAllocation(assetMake,
                        category, categoryCount, financialStartDate, amount,
                        location);

                finder.add(allocation);

            }

        } catch (Exception e) {
            System.out.println("INFO:Error fetching all Budget allocations ->" +
                               e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return finder;
    }

    public double getAssetDistributionAmount(String assetId) {
        double distributionAmount = 0.00d;
        FleetHistoryManager historyManager = new FleetHistoryManager();
        Asset asset = historyManager.findAssetById(assetId);

        if (asset == null) {
            /*
             Skip and return nothing.
             */
        } else {
            double amountDifference = asset.getCost() - asset.getResidualValue();
            distributionAmount = (double) (amountDifference /
                                           (double) (asset.getTotalLife()));
        }
        return distributionAmount;
    }

    /**
     * findAllBranchAllocation
     *
     * @return ArrayList
     */
    public ArrayList findAllBranchAllocationByType(String type) {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        ArrayList list = new ArrayList();
        String selectQuery =
                "SELECT LT_ID,BRANCH_ID,BRANCH_NAME,TOTAL_ALLOCATION," +
                "Q1_ALLOCATION,Q2_ALLOCATION,Q3_ALLOCATION,Q4_ALLOCATION," +
                " BALANCE_ALLOCATION,TYPE,CATEGORY   " +
                "FROM AM_ACQUISITION_BUDGET WHERE TYPE = '" + type + "'";

        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            rs = ps.executeQuery();

            while (rs.next()) {
                String id = rs.getString("LT_ID");
                String branchCode = rs.getString("BRANCH_ID");
                String branchName = rs.getString("BRANCH_NAME");
                String category = rs.getString("CATEGORY");
                double firstQauterAmount = rs.getDouble("Q1_ALLOCATION");
                double secondQuaterAmount = rs.getDouble("Q2_ALLOCATION");
                double thirdQauterAmount = rs.getDouble("Q3_ALLOCATION");
                double fourthQauterAmount = rs.getDouble("Q4_ALLOCATION");
                double totalAmount = rs.getDouble("TOTAL_ALLOCATION");
                double balanceAmount = rs.getDouble("BALANCE_ALLOCATION");
                // String type = rs.getString("TYPE");

                BranchAllocation allocation = new BranchAllocation(id,
                        branchCode,
                        branchName, firstQauterAmount, secondQuaterAmount,
                        thirdQauterAmount, fourthQauterAmount,
                        totalAmount, balanceAmount,
                        type);
                list.add(allocation);
            }

        } catch (Exception e) {
            System.out.println("INFO:Error fetching all Budget allocations ->" +
                               e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return list;

    }

    /**
     * findAllBranchAllocation
     *
     * @return ArrayList
     */
    public ArrayList findBranchCategoryAllocation(String branchCode) {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        ArrayList list = new ArrayList();
        String selectQuery =
                "SELECT LT_ID,BRANCH_ID,BRANCH_NAME,TOTAL_ALLOCATION," +
                "Q1_ALLOCATION,Q2_ALLOCATION,Q3_ALLOCATION,Q4_ALLOCATION," +
                " BALANCE_ALLOCATION,TYPE,CATEGORY,TYPE   " +
                "FROM AM_ACQUISITION_BUDGET WHERE BRANCH_ID = '" +
                branchCode +
                "'";

        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            rs = ps.executeQuery();

            while (rs.next()) {
                String id = rs.getString("LT_ID");
                String branchName = rs.getString("BRANCH_NAME");
                String category = rs.getString("CATEGORY");
                double firstQauterAmount = rs.getDouble("Q1_ALLOCATION");
                double secondQuaterAmount = rs.getDouble("Q2_ALLOCATION");
                double thirdQauterAmount = rs.getDouble("Q3_ALLOCATION");
                double fourthQauterAmount = rs.getDouble("Q4_ALLOCATION");
                double totalAmount = rs.getDouble("TOTAL_ALLOCATION");
                double balanceAmount = rs.getDouble("BALANCE_ALLOCATION");
                String type = rs.getString("TYPE");

                BranchAllocation allocation = new BranchAllocation(id,
                        branchCode,
                        branchName, firstQauterAmount, secondQuaterAmount,
                        thirdQauterAmount, fourthQauterAmount,
                        totalAmount, balanceAmount,
                        type);
                allocation.setCategory(category);
                list.add(allocation);
            }

        } catch (Exception e) {
            System.out.println("INFO:Error fetching all Budget allocations ->" +
                               e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return list;

    }


    /**
     * findBranchAllocationByCode
     *
     * @param branchCode String
     * @return BranchAllocation
     */
    public BranchAllocation findBranchAllocationById(String id) {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        BranchAllocation allocation = null;
        String selectQuery =
                "SELECT LT_ID,BRANCH_ID,BRANCH_NAME,TOTAL_ALLOCATION," +
                "Q1_ALLOCATION,Q2_ALLOCATION,Q3_ALLOCATION,Q4_ALLOCATION," +
                "BALANCE_ALLOCATION,TYPE,CATEGORY   " +
                "FROM AM_ACQUISITION_BUDGET WHERE LT_ID = ?";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            ps.setString(1, id);
            rs = ps.executeQuery();

            while (rs.next()) {
                //String id = rs.getString("SysID");
                String branchCode = rs.getString("BRANCH_ID");
                String branchName = rs.getString("BRANCH_NAME");
                double firstQauterAmount = rs.getDouble("Q1_ALLOCATION");
                double secondQuaterAmount = rs.getDouble("Q2_ALLOCATION");
                double thirdQauterAmount = rs.getDouble("Q3_ALLOCATION");
                double fourthQauterAmount = rs.getDouble("Q4_ALLOCATION");
                double totalAmount = rs.getDouble("TOTAL_ALLOCATION");
                double balanceAmount = rs.getDouble("BALANCE_ALLOCATION");
                String type = rs.getString("TYPE");
                String category = rs.getString("CATEGORY");

                allocation = new BranchAllocation(id, branchCode, branchName,
                                                  firstQauterAmount,
                                                  secondQuaterAmount,
                                                  thirdQauterAmount,
                                                  fourthQauterAmount,
                                                  totalAmount, balanceAmount,
                                                  type);
                allocation.setCategory(category);
            }

        } catch (Exception e) {
            System.out.println(
                    "INFO:Error fetching  Budget allocation for Branch ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return allocation;

    }

    public void deleteBranchCategoryAllocation(String branchCode,
                                               String category) {
        String query = "DELETE FROM AM_ACQUISITION_BUDGET " +
                       "WHERE BRANCH_ID = ? AND CATEGORY = ?";
        Connection con = null;
        PreparedStatement ps = null;
        try {

            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);
            ps.setString(1, branchCode);
            ps.setString(2, category);
            ps.execute();

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error Deleting Category Allocation ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps);
        }
    }


    public boolean isExistingBranchAllocation(String branchCode,
                                              String category) {
        boolean isExisting = false;
        String query = "SELECT COUNT(CATEGORY) FROM AM_ACQUISITION_BUDGET " +
                       "WHERE BRANCH_ID = ? AND CATEGORY = ?";
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        try {

            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);
            ps.setString(1, branchCode);
            ps.setString(2, category);
            rs = ps.executeQuery();

            while (rs.next()) {
                int counter = rs.getInt(1);
                if (counter > 0) {
                    isExisting = true;
                }
            }

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error Checking existence of Category Allocation ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return isExisting;
    }

    public boolean isExistingFuelAllocation(String assetMake, String category) {
        boolean isExisting = false;
        String query = "SELECT COUNT(CATEGORY) FROM AM_FUEL_BUDGET " +
                       "WHERE ASSET_MAKE = ? AND CATEGORY = ?";
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        try {

            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);
            ps.setString(1, assetMake);
            ps.setString(2, category);
            rs = ps.executeQuery();

            while (rs.next()) {
                int counter = rs.getInt(1);
                if (counter > 0) {
                    isExisting = true;
                }
            }

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error Checking existence of FUEL Allocation ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return isExisting;
    }

    public void deleteFuelAllocation(String assetMake, String category) {
        String query = "DELETE FROM AM_FUEL_BUDGET " +
                       "WHERE ASSET_MAKE = ? AND CATEGORY = ?";
        Connection con = null;
        PreparedStatement ps = null;
        try {

            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);
            ps.setString(1, assetMake);
            ps.setString(2, category);
            ps.execute();

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error removing FUEL Allocation ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps);
        }

    }

    /**
     * AssetMakeAllocation
     *
     * findBranchAllocationByCode
     *
     * @param branchCode String
     * @return BranchAllocation
     */
    public ArrayList findMaintenanceAllocationByCategory(String categoryCode) {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        ArrayList allocations = new ArrayList();
        String selectQuery =
                "SELECT ASSET_MAKE,COUNT(MAKE_CODE) AS COUNTER,SUM(YEAR_BELOW1) AS YEAR_BELOW1," +
                "SUM(YEAR_BETWEEN2) AS YEAR_BETWEEN2,SUM(YEAR_BETWEEN3) AS YEAR_BETWEEN3," +
                "SUM(YEAR_BETWEEN4) AS YEAR_BETWEEN4,SUM(YEAR_ABOVE4) AS YEAR_ABOVE4   " +
                "FROM AM_MAINTENANCE_BUDGET  " +
                "GROUP BY ASSET_MAKE       " +
                "ORDER BY 1";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            // ps.setString(1, categoryCode);
            rs = ps.executeQuery();

            while (rs.next()) {
                String id = "";
                String assetId = "";
                String assetMake = rs.getString("ASSET_MAKE");
                String assetName = rs.getString("ASSET_MAKE");
                String makeCode = rs.getString("ASSET_MAKE"); ;
                String make = rs.getString("ASSET_MAKE");
                String category = "";
                int makeCount = rs.getInt("COUNTER");
                double yearBelow1 = rs.getDouble("YEAR_BELOW1");
                double yearLG2 = rs.getDouble("YEAR_BETWEEN2");
                double yearLG3 = rs.getDouble("YEAR_BETWEEN3");
                double yearLG4 = rs.getDouble("YEAR_BETWEEN4");
                double yearAbove4 = rs.getDouble("YEAR_ABOVE4");

                AssetMakeAllocation makeAllocation = new AssetMakeAllocation(id,
                        assetId, assetName, makeCode, make, category,
                        yearBelow1,
                        yearLG2, yearLG3, yearLG4, yearAbove4);
                makeAllocation.setMakeCount(makeCount);

                allocations.add(makeAllocation);
            }

        } catch (Exception e) {
            System.out.println(
                    "INFO:Error fetching  make allocation list ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return allocations;

    }

    /**
     * AssetMakeAllocation
     *
     * findBranchAllocationByCode
     *
     * @param branchCode String
     * @return BranchAllocation
     */
    public ArrayList findMaintenanceSummaryAllocation() {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        ArrayList allocations = new ArrayList();
        String selectQuery =
                "SELECT B.ASSETMAKE,A.MAKE_CODE,COUNT(A.MAKE_CODE) AS COUNTER," +
                "SUM(A.YEAR_BELOW1) AS YEAR_BELOW1," +
                "SUM(A.YEAR_BETWEEN2) AS YEAR_BETWEEN2," +
                "SUM(A.YEAR_BETWEEN3) AS YEAR_BETWEEN3," +
                "SUM(A.YEAR_BETWEEN4) AS YEAR_BETWEEN4," +
                "SUM(A.YEAR_ABOVE4) AS YEAR_ABOVE4      " +
                "FROM AM_MAINTENANCE_BUDGET A, AM_GB_ASSETMAKE B  " +
                "WHERE A.MAKE_CODE = B.ASSETMAKE_ID      " +
                "GROUP BY B.ASSETMAKE,A.MAKE_CODE ORDER BY 1       ";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            rs = ps.executeQuery();

            while (rs.next()) {
                String id = "";
                String assetId = "";
                String assetMake = rs.getString("ASSETMAKE");
                String assetName = assetMake;
                String makeCode = rs.getString("MAKE_CODE"); ;
                String make = rs.getString("ASSETMAKE");
                String category = "";
                int makeCount = rs.getInt("COUNTER");
                double yearBelow1 = rs.getDouble("YEAR_BELOW1");
                double yearLG2 = rs.getDouble("YEAR_BETWEEN2");
                double yearLG3 = rs.getDouble("YEAR_BETWEEN3");
                double yearLG4 = rs.getDouble("YEAR_BETWEEN4");
                double yearAbove4 = rs.getDouble("YEAR_ABOVE4");

                AssetMakeAllocation makeAllocation = new AssetMakeAllocation(id,
                        assetId, assetName, makeCode, make, category,
                        yearBelow1,
                        yearLG2, yearLG3, yearLG4, yearAbove4);
                makeAllocation.setMakeCount(makeCount);

                allocations.add(makeAllocation);
            }

        } catch (Exception e) {
            System.out.println(
                    "INFO:Error fetching  Maintenance Summary Allocation ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return allocations;

    }


    /**
     * AssetMakeAllocation
     *
     * findBranchAllocationByCode
     *
     * @param branchCode String
     * @return BranchAllocation
     */
    public ArrayList findFuelBudgetSummary() {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        ArrayList allocations = new ArrayList();
        String selectQuery =
                "SELECT MAKE_CODE,CATEGORY,LOCATION ,COUNT(MAKE_CODE) AS COUNTER," +
                "SUM(amount) AS AMOUNT  " +
                "FROM AM_FUEL_BUDGET    " +
                "GROUP BY MAKE_CODE, CATEGORY, LOCATION  " +
                "ORDER BY 1, 2, 3  ";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            rs = ps.executeQuery();

            while (rs.next()) {

                String assetMake = rs.getString("MAKE_CODE");
                String category = rs.getString("CATEGORY");
                int categoryCount = rs.getInt("COUNTER");
                String financialStartDate = "";
                double amount = rs.getDouble("AMOUNT");
                String location = rs.getString("LOCATION");

                FuelAllocation fuelAllocation = new FuelAllocation(
                        assetMake, category, categoryCount,
                        financialStartDate, amount, location);

                allocations.add(fuelAllocation);
            }

        } catch (Exception e) {
            System.out.println(
                    "INFO:Error fetching fuel allocation Summary ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return allocations;

    }


    /**
     * describeCategory
     *
     * @param categoryCode String
     * @return String
     */
    public String describeCategory(String categoryCode) {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        String description = "";
        String selectQuery = "SELECT CATEGORY_NAME FROM AM_AD_CATEGORY  " +
                             "WHERE CATEGORY_ID = ?";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            ps.setInt(1, Integer.parseInt(categoryCode));
            rs = ps.executeQuery();

            while (rs.next()) {
                description = rs.getString(1);
            }

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error Describing Category->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return description;

    }

    /**
     * describeCategory
     *
     * @param categoryCode String
     * @return String
     */
    public String describeMake(String makeid) {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        String description = "";
        String selectQuery = "SELECT ASSETMAKE FROM am_gb_assetmake  " +
                             "WHERE ASSETMAKE_ID = ?";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            ps.setInt(1, Integer.parseInt(makeid));
            rs = ps.executeQuery();

            while (rs.next()) {
                description = rs.getString(1);
            }

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error Describing Asset Make->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return description;

    }


    /**
     * describeCategory
     *
     * @param categoryCode String
     * @return String
     */
    public String describeCategoryCode(String categoryCode) {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        String description = "";
        String selectQuery = "SELECT CATEGORY_NAME FROM AM_AD_CATEGORY  " +
                             "WHERE CATEGORY_CODE = ?";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            ps.setString(1, categoryCode);
            rs = ps.executeQuery();

            while (rs.next()) {
                description = rs.getString(1);
            }

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error Describing Category->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return description;

    }


    /**
     * describeCategory
     *
     * @param categoryCode String
     * @return String
     */
    public String getBranchName(String branchCode) {
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        String description = "";
        String selectQuery = "SELECT BRANCH_NAME FROM am_ad_branch  " +
                             "WHERE BRANCH_ID = ?";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            ps.setInt(1, Integer.parseInt(branchCode));
            rs = ps.executeQuery();

            while (rs.next()) {
                description = rs.getString(1);
            }

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error Describing Branch->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return description;

    }

    /**
     * describeCategory
     *
     * @param categoryCode String
     * @return String
     */
    public String getFinancialStartDate() {
        String dates[] = this.getFinancialDates();
        return dates[0];
    }

    public String[] getFinancialDates() {

        SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        String[] finDates = new String[2];
        String selectQuery = "SELECT FINANCIAL_START_DATE,FINANCIAL_END_DATE " +
                             "FROM AM_GB_COMPANY";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            rs = ps.executeQuery();

            while (rs.next()) {
                finDates[0] = sdf.format(rs.getDate(1));
                finDates[1] = sdf.format(rs.getDate(2));
            }

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error fetching financial Dates ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return finDates;

    }

    public void performYearEnd() {

        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        String UPDATE_QUERY = "UPDATE FT_FLEET_MASTER  " +
                              "SET PREMIUM_PTD = 0.0,MAINT_PTD = 0.0,FUEL_PTD = 0.0" +
                              ",ACCIDENT_COST_PTD = 0.0,LICENCE_PERMIT_PTD = 0.0" +
                              ",INSURANCE_COST_PTD = 0.0,MAINT_BUDGET = 0.0" +
                              ",MAINT_ACTUAL = 0.0,MAINT_Q1 = 0.0" +
                              ",MAINT_A1 = 0.0,MAINT_Q2 = 0.0,MAINT_A2 = 0.0" +
                              ",MAINT_Q3 = 0.0,MAINT_A3 = 0.0,MAINT_Q4 = 0.0" +
                              ",MAINT_A4 = 0.0,FUEL_BUDGET = 0.0,FUEL_ACTUAL = 0.0";

        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(UPDATE_QUERY);
            ps.execute();

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error performing year end ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps);
        }

    }


    public boolean isQuarterlyPMRequired() {

        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        boolean isRequired = false;
        String selectQuery = "SELECT require_quarterly_pm FROM AM_GB_COMPANY";
        try {
            con = getConnection("fixedasset");
            ps = con.prepareStatement(selectQuery);
            rs = ps.executeQuery();

            while (rs.next()) {
                String required = rs.getString(1);
                if (required != null && required.equalsIgnoreCase("Y")) {
                    isRequired = true;
                }
            }

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error determing if PM is required ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }

        return isRequired;

    }


    public String[] getAssetLocations() {

        String[] locations = null;
        String query = "SELECT DISTINCT(LOCATION) FROM am_gb_location ";
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        ArrayList list = new ArrayList();
        try {

            con = getConnection("fixedasset");
            ps = con.prepareStatement(query);
            rs = ps.executeQuery();

            while (rs.next()) {
                list.add(rs.getString(1));
            }

        } catch (Exception e) {
            System.out.println(
                    "WARNING:Error fetching Asset Location ->" +
                    e.getMessage());
        } finally {
            closeConnection(con, ps, rs);
        }
        locations = (String[]) list.toArray(new String[list.size()]);
        return locations;

    }

    public static void main(String[] args) {
        FleetBudgetManager f = new FleetBudgetManager();
        System.out.println("Asset Amount = " +
                           f.getAssetDistributionAmount("FCMB/PORT/MV/58"));
    }

}
